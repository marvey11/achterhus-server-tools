#! /usr/bin/env python3

import json
import sys
from pathlib import Path


def load_json_config(path: Path) -> dict[str, str]:
    """Loads JSON and ensures it's a flat dictionary of strings."""
    if not path.exists():
        print(f"⚠️  Note: {path.name} not found. Using defaults.")
        return {}

    try:
        with open(path, encoding="utf-8") as f:
            data = json.load(f)
            # Ensure we are returning strings for the .env format
            return {str(k): str(v) for k, v in data.items()}
    except json.JSONDecodeError:
        print(f"❌ Error: {path.name} is not valid JSON.", file=sys.stderr)
        sys.exit(1)


project_root = Path(__file__).resolve().parent.parent
json_env_file = project_root / ".env.json"

user_home = Path.home()

json_config = load_json_config(json_env_file)

env_config = {
    "SERVICE_STATUS_DIR": (
        user_home / json_config.get("status-dir", ".cache/achterhus/status")
    ).resolve(),
    "PHOTO_INBOX": user_home / "photo-inbox",
    "PHOTO_STORAGE": (
        Path(json_config.get("storage-dir", str(user_home))) / "photo"
    ),
}

env_path = project_root / ".env"
with open(env_path, "w", encoding="utf-8") as env_file:
    env_file.write("# GENERATED BY generate_env.py - DO NOT EDIT\n")
    for key, value in env_config.items():
        # Wrap in quotes to prevent bash word-splitting on spaces
        env_file.write(f'{key}="{value}"\n')

print(f"✅ Created {env_path}")
